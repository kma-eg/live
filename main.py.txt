import telebot
import yt_dlp
import os
import random
from telebot import types
from flask import Flask
from threading import Thread

# --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± ---
app = Flask('')

@app.route('/')
def home():
    return "<b>Bot is running... ğŸš€</b>"

def run():
    app.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run)
    t.start()

# --- 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ØªÙˆÙƒÙ† ---
BOT_TOKEN = os.environ.get('TOKEN')
ADMIN_ID = os.environ.get('ADMIN_ID')

MAINTENANCE_STATUS = {
    'youtube': True,
    'facebook': False,
    'instagram': False,
    'tiktok': False
}

if not BOT_TOKEN:
    print("Error: TOKEN is missing.")

bot = telebot.TeleBot(BOT_TOKEN)
users_file = "users.txt"
channel_file = "force_sub.txt"

# ÙÙ„ØªØ± Ø§Ù„Ø­Ù…Ø§ÙŠØ©
BLOCKED_KEYWORDS = [
    "xnxx", "pornhub", "xvideos", "sex", "xxx", "nude", "pussy", 
    "dick", "cock", "boobs", "hentai", "milf", "sharmota", "neek", 
    "nik", "sks", "film sex", "Ø³ÙƒØ³", "Ù†ÙŠÙƒ", "Ø§Ø¨Ø§Ø­ÙŠ", "Ø´Ø±Ù…ÙˆØ·Ø©", 
    "toz", "kuss"
]

# ğŸ”¥ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ù…Ø§Ø³ÙŠØ© (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ù†Ø§Ù‚Øµ)
SUCCESS_MSGS = [
    "ğŸš€ Ø¹Ø§Ø´! ØªÙ… Ù‚ÙØ´ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!",
    "ğŸ«¡ Ø·Ù„Ø¨Ùƒ Ø£ÙˆØ§Ù…Ø±ØŒ Ø«ÙˆØ§Ù†ÙŠ ÙˆÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ...",
    "ğŸ“¦ Ø¬Ø§Ø±ÙŠ ØªØºÙ„ÙŠÙ Ø§Ù„Ø·Ù„Ø¨... Ø§Ø³ØªØ¹Ø¯!",
    "ğŸ”¥ Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ ÙŠØ§ ÙˆØ­Ø´... Ù„Ø­Ø¸Ø© ÙˆØ§Ø­Ø¯Ø©!",
    "ğŸ‰ ÙˆÙ„Ø§ ÙŠÙ‡Ù…ÙƒØŒ Ø¬Ø¨Ù†Ø§Ù„Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø«Ø§Ù†ÙŠØ©!",
    "ğŸ˜ Ø§Ù†Øª ØªØ¤Ù…Ø±.. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."
]

# --- 3. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---

def is_safe_content(text):
    text = text.lower()
    for word in BLOCKED_KEYWORDS:
        if word in text:
            return False
    return True

def save_and_notify_admin(message):
    user_id = str(message.from_user.id)
    first_name = message.from_user.first_name
    username = message.from_user.username or "No User"
    
    if not os.path.exists(users_file):
        with open(users_file, "w") as f: pass
    
    with open(users_file, "r") as f:
        users = f.read().splitlines()
    
    if user_id not in users:
        with open(users_file, "a") as f:
            f.write(user_id + "\n")
        
        if ADMIN_ID:
            msg = (
                f"ğŸš€ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨ÙˆØª!\n\n"
                f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {first_name}\n"
                f"ğŸ“§ Ø§Ù„ÙŠÙˆØ²Ø±: @{username}\n"
                f"ğŸ†” Ø§Ù„Ø£ÙŠØ¯ÙŠ: `{user_id}`"
            )
            try:
                bot.send_message(ADMIN_ID, msg, parse_mode="Markdown")
            except:
                pass
        return True
    return False

def check_sub(user_id):
    if not os.path.exists(channel_file): return True
    with open(channel_file, "r") as f: ch_user = f.read().strip()
    if not ch_user: return True
    try:
        member = bot.get_chat_member(ch_user, user_id)
        if member.status in ['creator', 'administrator', 'member']: return True
    except: return True
    return False

# --- 4. Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ---

@bot.message_handler(commands=['start'])
def send_welcome(message):
    save_and_notify_admin(message)
    
    welcome_text = (
        f"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ {message.from_user.first_name}! ğŸ‘‹\n\n"
        "ğŸ¤– Ø£Ù†Ø§ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„\n"
        "Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ ØªØ­Ù…Ù„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Ø£ØºÙ„Ø¨\n"
        "Ø§Ù„Ù…Ù†ØµØ§Øª Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©:\n\n"
        "1 ÙŠÙˆØªÙŠÙˆØ¨ (Youtube) âš ï¸ (ØµÙŠØ§Ù†Ø©)\n"
        "2 ØªÙŠÙƒ ØªÙˆÙƒ (TikTok) - Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ© âœ…\n"
        "3 Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… (Reels & Posts) âœ…\n"
        "4 ÙÙŠØ³Ø¨ÙˆÙƒ (Facebook) âœ…\n\n"
        "ğŸ’¡  Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:\n"
        "1 Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±\n"
        "2 Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¨Ø­Ø« (ÙŠÙˆØªÙŠÙˆØ¨ ÙÙ‚Ø·)\n\n"
        "ã€°ã€°ã€°ã€°ã€°ã€°ã€°ã€°ã€°\n"
        "ğŸ‘¨â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±: @kareemcv"
    )

    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add(types.InlineKeyboardButton("ğŸ“¢ Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø·ÙˆØ±", url="https://t.me/+8o0uI_JLmYwwZWJk"))
    
    current_user = str(message.from_user.id).strip()
    admin_clean = str(ADMIN_ID).strip() if ADMIN_ID else ""
    if admin_clean and current_user == admin_clean:
        markup.add(types.InlineKeyboardButton("ğŸ‘®â€â™‚ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", callback_data="admin_main"))

    try:
        with open('start_image.jpg', 'rb') as photo:
            bot.send_photo(message.chat.id, photo, caption=welcome_text, reply_markup=markup)
    except:
        bot.send_message(message.chat.id, welcome_text, reply_markup=markup)

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    user_text = message.text
    user_id = message.from_user.id

    # 1. Ø§Ù„Ø­Ù…Ø§ÙŠØ©
    if not is_safe_content(user_text):
        bot.reply_to(message, "ğŸš« Ù…Ø­ØªÙˆÙ‰ Ù…Ø­Ø¸ÙˆØ±!")
        return

    # 2. Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    if not check_sub(user_id):
        bot.reply_to(message, "âš ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹.")
        return

    # --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø· ---
    if "http" in user_text:
        # ØµÙŠØ§Ù†Ø© ÙŠÙˆØªÙŠÙˆØ¨
        if ("youtube.com" in user_text or "youtu.be" in user_text) and MAINTENANCE_STATUS['youtube']:
            bot.reply_to(message, "âš ï¸ ÙŠÙˆØªÙŠÙˆØ¨ ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
            return

        status_msg = bot.reply_to(message, "ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...")
        
        try:
            ydl_opts = {'quiet': True, 'no_warnings': True, 'ignoreerrors': True, 'nocheckcertificate': True}
            
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(user_text, download=False)
            
            if not info:
                bot.edit_message_text("âŒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø£Ùˆ Ø®Ø§Øµ.", chat_id=status_msg.chat.id, message_id=status_msg.message_id)
                return

            title = info.get('title', 'Link')
            thumbnail = info.get('thumbnail')
            duration = info.get('duration') # Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            linked_title = f"[{title}]({user_text})"
            
            # ğŸ”¥ Ø§Ø®ØªÙŠØ§Ø± Ø±Ø³Ø§Ù„Ø© Ø­Ù…Ø§Ø³ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            motivational_msg = random.choice(SUCCESS_MSGS)

            # === [Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‡Ù†Ø§] ===
            
            if duration and duration > 0:
                # -- Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) --
                markup = types.InlineKeyboardMarkup(row_width=2)
                # Ø§Ù„Ø¬ÙˆØ¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                markup.add(
                    types.InlineKeyboardButton("ğŸ¥ 720p", callback_data="dl|720"),
                    types.InlineKeyboardButton("ğŸ¥ 480p", callback_data="dl|480")
                )
                markup.add(
                    types.InlineKeyboardButton("ğŸ¥ 360p", callback_data="dl|360"),
                    types.InlineKeyboardButton("ğŸ¥ 240p", callback_data="dl|240")
                )
                markup.add(
                    types.InlineKeyboardButton("ğŸ¥ 144p", callback_data="dl|144"),
                    types.InlineKeyboardButton("ğŸµ Audio", callback_data="dl|audio")
                )
                markup.add(types.InlineKeyboardButton("âŒ Ø¥Ù„ØºØ§Ø¡", callback_data="cancel"))

                bot.delete_message(message.chat.id, status_msg.message_id)
                
                # Ø§Ù„ÙƒØ§Ø¨Ø´Ù† Ø¨Ø§Ù„Ø­Ù…Ø§Ø³ ğŸ”¥
                caption_text = f"ğŸ¬ {linked_title}\n\n{motivational_msg}\nğŸ‘‡ Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø©:"
                
                if thumbnail:
                    bot.send_photo(message.chat.id, thumbnail, caption=caption_text, parse_mode="Markdown", reply_markup=markup)
                else:
                    bot.send_message(message.chat.id, caption_text, parse_mode="Markdown", reply_markup=markup)
            
            else:
                # -- Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØ± (ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±) --
                bot.edit_message_text(f"{motivational_msg}\nğŸ–¼ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±...", chat_id=status_msg.chat.id, message_id=status_msg.message_id)
                
                # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
                ydl_opts_img = {
                    'outtmpl': 'media/%(title)s.%(ext)s',
                    'quiet': True,
                    'max_filesize': 50*1024*1024,
                    'nocheckcertificate': True
                }
                with yt_dlp.YoutubeDL(ydl_opts_img) as ydl_img:
                    info_img = ydl_img.extract_info(user_text, download=True)
                    filename = ydl_img.prepare_filename(info_img)
                    
                    caption = f"âœ… @kareemcv"
                    with open(filename, 'rb') as f:
                        bot.send_photo(message.chat.id, f, caption=caption)
                    
                    if os.path.exists(filename): os.remove(filename)
                    bot.delete_message(message.chat.id, status_msg.message_id)

        except Exception as e:
            # Ù„Ùˆ Ø­ØµÙ„ Ø®Ø·Ø£
            bot.edit_message_text(f"âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø§Ù…).", chat_id=status_msg.chat.id, message_id=status_msg.message_id)

    # --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø­Ø« ---
    else:
        markup = types.InlineKeyboardMarkup(row_width=1)
        yt_text = "ğŸ”´ ÙŠÙˆØªÙŠÙˆØ¨ (ØµÙŠØ§Ù†Ø©)" if MAINTENANCE_STATUS['youtube'] else "âœ… ÙŠÙˆØªÙŠÙˆØ¨"
        markup.add(types.InlineKeyboardButton(yt_text, callback_data="search_yt"))
        
        bot.reply_to(message, f"ğŸ§ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: {user_text}\n(Ø§Ù„Ø¨Ø­Ø« Ù…ØªØ§Ø­ Ù„Ù„ÙŠÙˆØªÙŠÙˆØ¨ ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹)", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    data = call.data
    
    if data == "cancel":
        bot.delete_message(call.message.chat.id, call.message.message_id)
        return

    if data.startswith("dl|"):
        mode = data.split("|")[1]
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø·
        original_url = ""
        if call.message.reply_to_message:
            original_url = call.message.reply_to_message.text
        elif call.message.caption_entities:
            for entity in call.message.caption_entities:
                if entity.type == "text_link":
                    original_url = entity.url
                    break
        
        if not original_url:
             if call.message.caption:
                 import re
                 urls = re.findall(r'(https?://[^\s]+)', call.message.caption)
                 if urls: original_url = urls[0]

        if not original_url:
            bot.answer_callback_query(call.id, "âŒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…ÙÙ‚ÙˆØ¯.")
            return
        
        bot.edit_message_caption(caption=f"ğŸš€ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ({mode})...", chat_id=call.message.chat.id, message_id=call.message.message_id)
        
        try:
            ydl_opts = {
                'outtmpl': 'media/%(title)s.%(ext)s',
                'quiet': True,
                'max_filesize': 50*1024*1024,
                'nocheckcertificate': True
            }
            
            # Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            if mode == "audio":
                ydl_opts['format'] = 'bestaudio/best'
            elif mode == "720":
                ydl_opts['format'] = 'best[height<=720][ext=mp4]/best[ext=mp4]/best'
            elif mode == "480":
                ydl_opts['format'] = 'best[height<=480][ext=mp4]/best[ext=mp4]/best'
            elif mode == "360":
                ydl_opts['format'] = 'best[height<=360][ext=mp4]/best[ext=mp4]/best'
            elif mode == "240":
                ydl_opts['format'] = 'best[height<=240][ext=mp4]/best[ext=mp4]/best'
            elif mode == "144":
                ydl_opts['format'] = 'best[height<=144][ext=mp4]/best[ext=mp4]/best'
            else:
                ydl_opts['format'] = 'best[ext=mp4]/best'

            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(original_url, download=True)
                filename = ydl.prepare_filename(info)
                caption = f"âœ… @kma_tbot "
                
                # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù (ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØª)
                with open(filename, 'rb') as f:
                    if mode == "audio":
                        bot.send_audio(call.message.chat.id, f, caption=caption)
                    else:
                        bot.send_video(call.message.chat.id, f, caption=caption, supports_streaming=True)
                
                if os.path.exists(filename): os.remove(filename)
                
                # Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                bot.delete_message(call.message.chat.id, call.message.message_id)

        except Exception as e:
            bot.send_message(call.message.chat.id, "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.")

    elif data == "search_yt":
         bot.answer_callback_query(call.id, "âš ï¸ ÙŠÙˆØªÙŠÙˆØ¨ Ù…ØºÙ„Ù‚ Ù„Ù„ØµÙŠØ§Ù†Ø©!", show_alert=True)

if __name__ == "__main__":
    keep_alive()
    bot.infinity_polling()